const initTemplate=(e,t)=>{let l={};return l.rootNodeSelector=e,l.rootNode=document.querySelector(e),l.template=l.rootNode.outerHTML,l.data=t,l.localDataStack=[],l.fullRender=!0,renderTemplate(l),l},renderTemplate=ctx=>{let TPL_FOR="tpl-for",TPL_IF="tpl-if",resolveVarRefs=e=>{let t=(e,t)=>{let l=e,r=0;for(;r<t.length;){let n=t[r];if(["string","number","boolean","array","object"].includes(typeof l[n]))l=l[n],r++;else break}return l===e&&(l=void 0),{ret:l,tokens:r}},l=e,r=/(?:"[^"]*"|'[^']*')/g,n=[...l.matchAll(r)];for(let o=0;o<n.length;o++){let a=n[o];l=l.substring(0,a.index)+" ".repeat(a[0].length)+l.substring(a.index+a[0].length)}let i=/[a-zA-Z_$][a-zA-Z$0-9_.-]*/g,d=[...l.matchAll(i)];for(let c=0;c<d.length;c++){let s=d[c],h=s[0].split("."),u;for(let m=ctx.localDataStack.length-1;m>=0&&u?.ret===void 0;m--)u=t(ctx.localDataStack[m],h);if(u?.ret===void 0&&(u=t(ctx.data,h)),u?.ret!==void 0){let g=0;for(let $=0;$<u.tokens;$++)g+=1+h[$].length;g--,e=e.substring(0,s.index)+JSON.stringify(u.ret)+e.substring(s.index+g)}}return e},evalDoubleCurlyBraces=txt=>{let doubleCurlyBracketsRegEx=/{{([^}]*)}}/g,matches=[...txt.matchAll(doubleCurlyBracketsRegEx)];for(let i=matches.length-1;i>=0;i--){let match=matches[i],matchedExpr=match[1],matchedExprLen=matchedExpr.length;matchedExpr.startsWith("##")&&(matchedExpr=atob(matchedExpr.substring(2)));let processedExpr=resolveVarRefs(matchedExpr);try{let evaledExpr=eval("("+processedExpr+")");"object"==typeof evaledExpr&&(evaledExpr=JSON.stringify(evaledExpr)),txt=txt.slice(0,match.index)+evaledExpr+txt.slice(match.index+4+matchedExprLen)}catch(ignored){txt=txt.slice(0,match.index+2)+"##"+btoa(processedExpr)+txt.slice(match.index+2+matchedExprLen)}}return txt},evalTplDirectives=e=>{let t=RegExp(`${TPL_FOR}="([^;]*)`,"g"),l=[...e.matchAll(t)];for(let r=l.length-1;r>=0;r--){let n=l[r],o=n[1],a="##"+btoa(resolveVarRefs(o));e=e.slice(0,n.index+2+TPL_FOR.length)+a+e.slice(n.index+2+TPL_FOR.length+o.length)}let i=RegExp(`${TPL_IF}="([^"]*)`,"g"),d=[...e.matchAll(i)];for(let c=d.length-1;c>=0;c--){let s=d[c],h=s[1],u=resolveVarRefs(h);e=e.slice(0,s.index+2+TPL_IF.length)+u+e.slice(s.index+2+TPL_IF.length+h.length)}return e},handleTplIf=node=>{let namedItem=node.attributes.getNamedItem(TPL_IF);if(!namedItem)return{};try{let val=resolveVarRefs(namedItem.value),evalResult=eval(val);if(node.attributes.removeNamedItem(TPL_IF),!1==evalResult)return node.parentNode.removeChild(node),{nodeRemoved:!0}}catch(e){console.warn(`[${TPL_IF}] could not parse: ${namedItem.value}`)}return{}},handleTplFor=e=>{let t=e.attributes.getNamedItem(TPL_FOR);if(!t)return{};try{let l=t.value.split(";"),r=l[0].trim();r.startsWith("##")&&(r=atob(r.substring(2)));let n=JSON.parse(resolveVarRefs(r)),o=l[1].trim();e.attributes.removeNamedItem(TPL_FOR);let a=e.outerHTML;for(let i of n){let d={};d[o]=i,ctx.localDataStack.push(d);let c=evalTplDirectives(evalDoubleCurlyBraces(a));ctx.localDataStack.pop();let s=createVDOM(c);e.parentElement.insertBefore(s,e)}return e.parentNode.removeChild(e),{nodeRemoved:!0}}catch(h){console.warn(`[${TPL_FOR}] could not parse: ${t.value}`)}return{}},processNodes=e=>{let t={};if(!e||(t=handleTplIf(e)).nodeRemoved||(t=handleTplFor(e)).nodeRemoved)return t;let l=0;for(;l<e.children.length;){let r=e.children[l],n=processNodes(r);!n.nodeRemoved&&l++}return t},nodeType=e=>3===e.nodeType?"text":8===e.nodeType?"comment":e.nodeName,nodeContent=e=>e.childNodes?.length>0?null:e.textContent,updateAttributes=(e,t)=>{if(1!==e.nodeType||1!==t.nodeType)return;let l=e.attributes,r=t.attributes;if(0!==l.length||0!==r.length){for(let n=0;n<l.length;n++){let o=l[n].name;void 0===r[o]&&l.removeNamedItem(o)}for(let a=0;a<r.length;a++){let i=r[a];if(void 0===l[i.name]){let d=document.createAttribute(i.name);d.value=i.value,l.setNamedItem(d)}else l[i.name].value!==i.value&&(l[i.name].value=i.value)}}},diffAndUpdate=(e,t)=>{let l=Array.prototype.slice.call(e.childNodes),r=Array.prototype.slice.call(t.childNodes);updateAttributes(e,t);let n=l.length-r.length;for(;n>0;){let o=l[l.length-n];o.parentNode.removeChild(o),n--}r.forEach((t,r)=>{if(r>=l.length){e.appendChild(t.cloneNode(!0));return}if(nodeType(t)!==nodeType(l[r])){l[r].parentNode.replaceChild(t.cloneNode(!0),l[r]);return}let n=nodeContent(t),o=nodeContent(l[r]);if(n&&n!==o&&(l[r].textContent=n),updateAttributes(l[r],t),l[r].childNodes.length>0&&t.childNodes.length<1){l[r].replaceChildren();return}l[r].childNodes.length<1&&t.childNodes.length>0&&l[r].append(...t.childNodes),t.childNodes.length>0&&diffAndUpdate(l[r],t)})},vdom=createVDOM(evalDoubleCurlyBraces(ctx.template));removeInvisibility(vdom),processNodes(vdom),ctx.fullRender?(ctx.rootNode.outerHTML=vdom.outerHTML,ctx.rootNode=document.querySelector(ctx.rootNodeSelector),ctx.fullRender=!1):diffAndUpdate(ctx.rootNode,vdom)},createVDOM=e=>{let t=document.createElement("template");return t.innerHTML=e,t.content.children[0]},removeInvisibility=e=>{e.classList.remove("invisible"),0==e.classList.length&&e.attributes.removeNamedItem("class")};
