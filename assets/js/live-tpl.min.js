const initTemplate=(e,t,n=null)=>{let r={};return r.rootNodeSelector=e,r.rootNode=document.querySelector(e),r.template=r.rootNode.outerHTML,r.data=t,r.localData={},r.fullRender=!0,r.invisibilityCSSClass=n,r.changeListeners=new Map,renderTemplate(r),r},renderTemplate=ctx=>{const TPL_FOR="tpl-for",TPL_IF="tpl-if",TPL_MODEL="tpl-model",createVDOM=e=>{const t=document.createElement("template");return t.innerHTML=e,t.content.children[0]},tryToResolveVarRef=(e,t)=>{let n=e,r=0,l="";for(;r<t.length;){let e,o=t[r];if(o.includes("[")){const t=o.split("[");o=t[0],indexTxt=t[1].substring(0,t[1].length-1);const n=parseInt(resolveVarRefs(indexTxt));NaN!=n&&(e=n)}if(!["string","number","boolean","array","object"].includes(typeof n[o]))break;n=n[o],l+=`.${o}`,null!=e&&(n=n[e],l+=`[${e}]`),r++}return n===e&&(n=void 0),{ret:n,tokens:r,name:l.substring(1)}},resolveVarRefs=e=>{let t=e;const n=[...t.matchAll(/(?:"[^"]*"|'[^']*')/g)];for(let e=0;e<n.length;e++){const r=n[e];t=t.substring(0,r.index)+" ".repeat(r[0].length)+t.substring(r.index+r[0].length)}const r=[...t.matchAll(/[a-zA-Z_$]([a-zA-Z$0-9_.-]*(\[[a-zA-Z$0-9_.-]*\])?(\.)?)*/g)];for(let t=0;t<r.length;t++){let n=r[t],l=n[0].split("."),o=tryToResolveVarRef(ctx.localData,l);if(void 0===o?.ret&&(o=tryToResolveVarRef(ctx.data,l)),void 0!==o?.ret){let t=0;for(let e=0;e<o.tokens;e++)t+=1+l[e].length;t--,e=e.substring(0,n.index)+JSON.stringify(o.ret)+e.substring(n.index+t)}}return e},evalDoubleCurlyBraces=txt=>{const doubleCurlyBracketsRegEx=/{{([^}]*)}}/g,matches=[...txt.matchAll(doubleCurlyBracketsRegEx)];for(let i=matches.length-1;i>=0;i--){const match=matches[i];let matchedExpr=match[1],matchedExprLen=matchedExpr.length;matchedExpr.startsWith("##")&&(matchedExpr=atob(matchedExpr.substring(2)));const processedExpr=resolveVarRefs(matchedExpr);try{if("i"===processedExpr)throw Exception();let evaledExpr=eval("("+processedExpr+")");"object"==typeof evaledExpr&&(evaledExpr=JSON.stringify(evaledExpr)),txt=txt.slice(0,match.index)+evaledExpr+txt.slice(match.index+4+matchedExprLen)}catch(e){txt=txt.slice(0,match.index+2)+"##"+btoa(processedExpr)+txt.slice(match.index+2+matchedExprLen)}}return txt},evalTplDirectives=(e,t,n,r)=>{const l=new RegExp(`${TPL_FOR}="([^;]*);([^"]*)`,"g"),o=new RegExp(`^${n}(\\.|\\[)`,"g"),s=[...e.matchAll(l)];for(let n=s.length-1;n>=0;n--){const l=s[n];let a=l[1];if(a.includes("[")){let e=tryToResolveVarRef(ctx.data,a.split("."));null!=e?.ret&&(a=e?.name)}const d=o.test(a.trim())?";##"+btoa(`${t}[${r}].${a.split(".").filter(((e,t)=>t>0)).join(".")}`):";##"+btoa(a),c="##"+btoa(resolveVarRefs(a));e=e.slice(0,l.index+2+TPL_FOR.length)+c+e.slice(l.index+2+TPL_FOR.length+a.length,l.index+2+TPL_FOR.length+a.length+l[2].length+1)+d+e.slice(l.index+2+TPL_FOR.length+a.length+l[2].length+1)}const a=new RegExp(`${TPL_IF}="([^"]*)`,"g"),d=[...e.matchAll(a)];for(let t=d.length-1;t>=0;t--){const n=d[t];let r=n[1];const l=resolveVarRefs(r);e=e.slice(0,n.index+2+TPL_IF.length)+l+e.slice(n.index+2+TPL_IF.length+r.length)}const c=new RegExp(`${TPL_MODEL}="([^"]*)`,"g"),i=[...e.matchAll(c)];for(let l=i.length-1;l>=0;l--){const o=i[l];let s=o[1];if(s.trim()==n){const n=`${t}[${r}]`;e=e.slice(0,o.index+2+TPL_MODEL.length)+n+e.slice(o.index+2+TPL_MODEL.length+s.length)}}return e},convert=(e,t)=>"number"==typeof t?Number(e):"boolean"==typeof t?"true"==e.toLowerCase()||"1"==e||"t"==e||"y"===e:JSON.stringify(e),evalProxy=src=>function(){return eval(src)},tplModelChangeListener=e=>t=>{const n=t?.currentTarget?.value;if(null==n)return;let r=evalProxy(`this.${e}`).bind(ctx.data)();null!=r&&(evalProxy(`this.${e}=${convert(n,r)}`).bind(ctx.data)(),renderTemplate(ctx))},handleTplModel=(e,t)=>{const n=e.attributes.getNamedItem(TPL_MODEL);if(!n)return{};try{const r=n.value;t.add(r),e.attributes.removeNamedItem(TPL_MODEL);let l=ctx.changeListeners.get(r);l||(l=tplModelChangeListener(r),ctx.changeListeners.set(r,l)),e.removeEventListener("change",l),e.addEventListener("change",l),e.value=evalProxy(`this.${r}`).bind(ctx.data)()}catch(e){}return{}},handleTplIf=node=>{const namedItem=node.attributes.getNamedItem(TPL_IF);if(!namedItem)return{};try{const val=resolveVarRefs(namedItem.value),evalResult=eval(val);if(node.attributes.removeNamedItem(TPL_IF),0==evalResult)return node.parentNode.removeChild(node),{nodeRemoved:!0}}catch(e){}return{}},handleTplFor=e=>{const t=e.attributes.getNamedItem(TPL_FOR);if(!t)return{};try{const n=t.value.split(";");let r=n[0].trim();r.startsWith("##")&&(r=atob(r.substring(2)));const l=JSON.parse(resolveVarRefs(r)),o=n[1].trim();e.attributes.removeNamedItem(TPL_FOR);const s=e.outerHTML,a=n.length>=3?atob(n[2].substring(2)):r;for(let t=0;t<l.length;t++){let n=l[t];const r={};r[o]=n,ctx.localData=r;const d=evalTplDirectives(evalDoubleCurlyBraces(s),a,o,t);ctx.localData={};let c=createVDOM(d);e.parentElement.insertBefore(c,e)}return e.parentNode.removeChild(e),{nodeRemoved:!0}}catch(e){}return{}},preProcessNodes=e=>{let t={};if(!e)return t;if(t=handleTplIf(e),t.nodeRemoved)return t;if(t=handleTplFor(e),t.nodeRemoved)return t;let n=0;for(;n<e.children.length;){const t=e.children[n];preProcessNodes(t).nodeRemoved||n++}return t},postProcessNodes=(e,t)=>{let n={};if(!e)return n;if(n=handleTplModel(e,t),n.nodeRemoved)return n;let r=0;for(;r<e.children.length;){const n=e.children[r];postProcessNodes(n,t).nodeRemoved||r++}return n},removeUnreferencedChangeListenersFromCtx=e=>{const t=Array.from(e),n=Array.from(ctx.changeListeners.keys());for(const e of n)t.includes(e)||ctx.changeListeners.delete(e)},nodeType=e=>3===e.nodeType?"text":8===e.nodeType?"comment":e.nodeName,nodeContent=e=>e.childNodes?.length>0?null:e.textContent,updateAttributes=(e,t)=>{if(1!==e.nodeType||1!==t.nodeType)return;let n=e.attributes;const r=t.attributes;if(0!==n.length||0!==r.length){for(let e=0;e<n.length;e++){const t=n[e].name;void 0===r[t]&&n.removeNamedItem(t)}for(let e=0;e<r.length;e++){const t=r[e];if(void 0===n[t.name]){let e=document.createAttribute(t.name);e.value=t.value,n.setNamedItem(e)}else n[t.name].value!==t.value&&(n[t.name].value=t.value)}}},diffAndUpdate=(e,t)=>{let n=Array.prototype.slice.call(e.childNodes),r=Array.prototype.slice.call(t.childNodes);updateAttributes(e,t);let l=n.length-r.length;for(;l>0;){let e=n[n.length-l];e.parentNode.removeChild(e),l--}r.forEach(((t,r)=>{if(r>=n.length)return void e.appendChild(t.cloneNode(!0));if(nodeType(t)!==nodeType(n[r]))return void n[r].parentNode.replaceChild(t.cloneNode(!0),n[r]);const l=nodeContent(t),o=nodeContent(n[r]);l&&l!==o&&(n[r].textContent=l),updateAttributes(n[r],t),n[r].childNodes.length>0&&t.childNodes.length<1?n[r].replaceChildren():(n[r].childNodes.length<1&&t.childNodes.length>0&&n[r].append(...t.childNodes),t.childNodes.length>0&&diffAndUpdate(n[r],t))}))};let vdom=createVDOM(evalDoubleCurlyBraces(ctx.template));ctx.invisibilityCSSClass&&(vdom.classList.remove(ctx.invisibilityCSSClass),0==vdom.classList.length&&vdom.attributes.removeNamedItem("class")),preProcessNodes(vdom),ctx.fullRender?(ctx.rootNode.outerHTML=vdom.outerHTML,ctx.rootNode=document.querySelector(ctx.rootNodeSelector),ctx.fullRender=!1):diffAndUpdate(ctx.rootNode,vdom);let referencedTplModels=new Set;postProcessNodes(ctx.rootNode,referencedTplModels),removeUnreferencedChangeListenersFromCtx(referencedTplModels)};
